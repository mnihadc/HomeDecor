<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
</head>

<body>
    <div class="container pt-3">
        <h4 style="color: green;font-size: x-large;font-weight: bold;">Shop</h4>
        <div class="filter-bar container-fluid bg-light py-3">
            <div>
                <form id="filterForm" class="row align-items-center">
                    <div class="col-12 col-md-4 mb-3 mb-md-0">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search products..."
                            autocomplete="off" />
                        <div id="searchSuggestions" class="list-group position-absolute w-100"
                            style="z-index: 1000; display: none;"></div>
                    </div>
                    <div class="col-12 col-md-3 mb-3 mb-md-0">
                        <select class="form-control" id="categorySelect">
                            <option value="">None</option>
                            {{#each categories}}
                            <option value="{{category}}">{{category}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <div class="col-12 col-md-3 mb-3 mb-md-0">
                        <select class="form-control" id="priceRangeSelect">
                            <option value="">None</option>
                            <option value="0-50">$0 - $50</option>
                            <option value="51-100">$51 - $100</option>
                            <option value="101-200">$101 - $200</option>
                            <option value="201-500">$201 - $500</option>
                            <option value="500-1000">$500 - $1000</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2">
                        <button type="submit" class="btn btn-primary btn-block">Filter</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="product-section">
            <div class="container">
                <div class="row" id="productList">
                    {{#each products}}
                    <div class="col-12 col-md-4 col-lg-3 mb-5 mb-md-0 product-item" data-category="{{this.category}}"
                        data-price="{{#if this.offerPrice}}{{this.offerPrice}}{{else}}{{this.price}}{{/if}}">
                        <div class="product-item">
                            <img src="{{this.productImages}}" class="img-fluid product-thumbnail" alt="{{this.name}}">
                            <h3 class="product-title" style="color: black;">{{this.name}}</h3>
                            <h6 class="product-title" style="color: black;">{{this.category}}</h6>
                            <strong class="product-price">
                                {{#if this.offerPrice}}
                                <span class="product-price-old">${{this.offerPrice}}</span>
                                {{else}}
                                ${{this.price}}
                                {{/if}}
                            </strong>
                            <button class="add-to-cart-btn" style="border-radius: 7px;border: silver 1px;color: green;"
                                data-product-id="{{this._id}}">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
    </div>

    <footer class="footer-32892 pb-0" style="background: rgb(59, 55, 55);color: azure;padding-top: 2rem;">
        <!-- Footer content here -->
    </footer>
</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        const categorySelect = document.getElementById('categorySelect');
        const priceRangeSelect = document.getElementById('priceRangeSelect');
        const productList = document.getElementById('productList');
        const searchSuggestions = document.getElementById('searchSuggestions');

        function fetchProducts() {
            const params = new URLSearchParams({
                search: searchInput.value,
                category: categorySelect.value,
                priceRange: priceRangeSelect.value,
            });

            fetch(`/shop?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => {
                    productList.innerHTML = data.products.map(product => `
                <div class="col-12 col-md-4 col-lg-3 mb-4 product-item" 
                    data-category="${product.category}" 
                    data-price="${product.offerPrice || product.price}">
                    <div class="product-card">
                        <img src="${product.productImages}" class="img-fluid" alt="${product.name}">
                        <h5>${product.name}</h5>
                        <p>${product.category}</p>
                        <p class="product-price">
                            ${product.offerPrice ? `<span class="text-danger">$${product.offerPrice}</span> <del class="product-price-old">$${product.price}</del>` : `$${product.price}`}
                        </p>
                        <button class="add-to-cart-btn" style="border-radius: 7px; border: silver 1px; color: green;" data-product-id="${product._id}">
                            Add to Cart
                        </button>
                    </div>
                </div>
            `).join('');

                    // Reattach event listeners for the "Add to Cart" buttons
                    attachAddToCartListeners();
                });
        }


        searchInput.addEventListener('input', () => {
            if (searchInput.value.length > 2) {
                fetch(`/shop/suggestions?q=${searchInput.value}`)
                    .then(res => res.json())
                    .then(data => {
                        searchSuggestions.innerHTML = data.map(product => `
                                <div class="suggestion-item">${product.name}</div>
                            `).join('');
                        searchSuggestions.style.display = 'block';
                    });
            } else {
                searchSuggestions.style.display = 'none';
            }
        });

        searchSuggestions.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-item')) {
                searchInput.value = e.target.textContent;
                searchSuggestions.style.display = 'none';
                fetchProducts();
            }
        });

        categorySelect.addEventListener('change', fetchProducts);
        priceRangeSelect.addEventListener('change', fetchProducts);

        fetchProducts();
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const productList = document.getElementById('productList');

        // Attach event listener to the parent container (productList)
        productList.addEventListener('click', function (e) {
            // Check if the clicked element is a "Add to Cart" button
            if (e.target && e.target.classList.contains('add-to-cart-btn')) {
                const productId = e.target.getAttribute("data-product-id");

                fetch(`/cart/addtocart/${productId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                    .then(response => response.json().then(data => ({ status: response.status, message: data.message })))
                    .then(({ status, message }) => {
                        if (status === 201) {
                            alert(message);
                        } else if (status === 400) {
                            alert("Item is already in cart.");
                        } else if (status === 401) {
                            alert("Please log in to add items to the cart.");
                            window.location.href = "/auth/login";
                        } else {
                            alert("An unexpected error occurred.");
                        }
                    })
                    .catch(error => {
                        console.error("Error adding to cart:", error);
                        alert("An error occurred. Please try again later.");
                    });
            }
        });
    });

</script>


</html>